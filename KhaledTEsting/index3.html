<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title></title>



    <style>
        .active-user {
            display: inline-block;
            background-color: green;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 5px;
        }

        .not-active-user {
            display: inline-block;
            background-color: red;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin: 0 5px;
        }
    </style>
    <!-- The core Firebase JS SDK is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-app.js"></script>

    <!-- TODO: Add SDKs for Firebase products that you want to use
         https://firebase.google.com/docs/web/setup#available-libraries -->

    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-analytics.js"></script>

    <!--**** Remember to add the database script ***-->
    <script src="https://www.gstatic.com/firebasejs/7.14.6/firebase-database.js"></script>

    <!--Your web app's Firebase configuration-->
    <script>
        let ref_private_chats = []
        // sessionStorage.setItem("User", JSON.stringify())
        const firebaseConfig = {
            apiKey: "AIzaSyANdlvJ3vPkk_yn00EPFnOJ69ezOm_X0lA",
            authDomain: "peak-emitter-392420.firebaseapp.com",
            projectId: "peak-emitter-392420",
            storageBucket: "peak-emitter-392420.appspot.com",
            messagingSenderId: "511292139306",
            appId: "1:511292139306:web:45aa32f988521b03f62053",
            measurementId: "G-JE2RYQKVFM",
            databaseURL:
                "https://peak-emitter-392420-default-rtdb.europe-west1.firebasedatabase.app/", // Add your Firebase Database URL here
        };


        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.0/jquery.min.js"
        integrity="sha512-3gJwYpMe3QewGELv8k/BX9vcqhryRdzRMxVfq6ngyWXwo03GFEzjsUm8Q7RZcHPHksttq7/GFoxjCVUjkjvPdw=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        let user = {
            "Id": "1",
            "imgUrl": "https://picsum.photos/id/237/200/300"
        }
        function addMessage(otherUserId) {
            ref_private_chat = firebase.database().ref("messages/" + user.Id + "-chat-with-" + otherUserId);
            console.log("messaged")
            ref_private_chat.push().set({
                "from": user.Id,
                'to': `${otherUserId}`,
                "content": "yess"
            })
        }
        function goToChat(otherUserId) {
            // ref_private_chat = firebase.database().ref("messages/" + user.Id + "-chat-with-" + otherUserId);
            // console.log(ref_private_chat.key)
            // console.log(ref_private_chats)

            // renderPrivateChat(user.Id, otherUserId)
            // console.log("chat with" + otherUserId + " my id: " + user.Id)
        }

        function renderMessage(msg) {
            let ph2 = document.getElementById("ph2");
            const htmlContent =
                `
                <div class="message-row ${user.Id == msg.from ? "revers-flex" : ""}">
                    <div>
                        <img class="users-images" src="${msg.imgURL}" alt="">
                    </div>
                    <div class="message-contatiner">
                        <h2 class="users-names">Name: ${msg.name}</h2>
                        <p class="users-messages-contents">Message: ${msg.msg}</p>
                    </div>
                </div>
            `
            ph2.innerHTML += htmlContent
        }
        function renderPrivateChat(myId, otherId) {
            ref = firebase.database().ref("messages/" + myId + "-chat-with-" + otherId);
            ref.once("value", snapshot => {
                snapshot.forEach(element => {
                    console.log(element.val())
                    //renderMessage
                    getUserObj(otherId, (data) => {
                        console.log(data)
                        const msg = {
                            from: element.val().from,
                            imgURL: data.image,
                            msg: element.val().content,
                        }
                        renderMessage(msg)
                    })
                });
            })
        }
        function getUserObj(userId, callback) {

            $.ajax({
                type: "GET",
                dataType: "json",
                contentType: "application/json",
                username: "user",
                password: "admin",
                url: "https://proj.ruppin.ac.il/cgroup17/test2/tar1/api/UserMusics/GetUserById/Id/" + userId,
                success: function (data) {
                    let obj = {
                        "name": data.first + " " + data.last,
                        "image": data.imgUrl,
                        "userId": data.id
                    }
                    callback(obj)
                }
            });
        }
        function init() {
            getUsersStatusRender();
            ref2 = firebase.database().ref("online/");
            ref2.on("child_changed", snapshot => {
                snapshot.forEach(element => {
                    const userId = element.ref_.path.pieces_[1];
                    const userStatus = element.node_.value_
                    getUserObj(userId, (data) => {
                        console.log(data)
                        render(data, userStatus)
                    })
                });
            })
            msgArr = [];
            function getUsers(val) {
                $.ajax({
                    type: "GET",
                    dataType: "json",
                    contentType: "application/json",
                    username: "user",
                    password: "admin",
                    url: "https://proj.ruppin.ac.il/cgroup17/test2/tar1/api/UserMusics",
                    success: function (data) {
                        for (let item in data) {
                            ref_private_chats[`${data[item].id}`] = ""
                            val(data[item].id)
                        }
                    }
                });
            }
            getUsers(setUserOnline);


            getUsers(setUserOffline)
            function getUsersStatusRender() {
                ref2 = firebase.database().ref("online/");
                ref2.once("value", snapshot => {
                    snapshot.forEach(element => {
                        getUserObj(element.key, (data) => {
                            render(data, element.val().userOnline)
                        })
                    });
                })
            }
            let api = "https://proj.ruppin.ac.il/cgroup17/test2/tar1/api"
            function get_image_from_server(image_url) {
                return `${api}/Upload?fileName=${image_url}`;
            }

            // ref = firebase.database().ref("messages");
            function render(user2, userStatus) {
                // console.log(user, userStatus)
                const userNameSpan = document.getElementById(`span-${user2.userId}`)
                const userStatusDiv = document.getElementById(`div-${user2.userId}`)
                ref_private_chats[user2.userId] = firebase.database().ref("messages/" + user2.userId + "-chat-with-" + user.userId);
                ref_private_chats[user2.userId].on("child_added", (snapshot) => {
                    console.log(snapshot)
                })
                if (userNameSpan != null && userStatusDiv != null) {
                    userNameSpan.innerText = (user2.name)
                    userStatusDiv.className = `${userStatus}`
                    return
                }
                else {
                    const htmlContent =
                        `
                    <div onclick="goToChat(${user2.userId})">
                        <img class="users-images" src="${get_image_from_server(user2.image)}" alt="">
                        <span id="span-${user2.userId}">${user2.name}</span><div id="div-${user2.userId}" class="${userStatus}"></div>
                        </div>
                        <button onclick="addMessage(1)"></button>
                    `
                    ph.innerHTML += htmlContent
                }
            }

            function setUserOffline(userId) {
                ref2 = firebase.database().ref("online/" + userId);
                ref2.update({
                    userOnline: "not-active-user"
                });
            }
            function setUserOnline(userId) {
                ref2 = firebase.database().ref("online/" + userId);
                ref2.update({
                    userOnline: "active-user"
                });
            }
            //
            // deleteAll(firebase.database().ref("online/"), () => {

            // });

            // iam_online()
            // listen to incoming messages
            // listenToNewMessages();
            // // listen to removing messages
            // listenToRemove();
            // ph = document.getElementById("ph");
        }
        // function renderMessage(message) {
        //     const htmlContent =
        //         `
        //         <div class="message-row ${user.Id == msg.userId ? "revers-flex" : ""}">
        //             <div>
        //                 <img class="users-images" src="${msg.imgURL}" alt="">
        //             </div>
        //             <div class="message-contatiner">
        //                 <h2 class="users-names">Name: ${msg.name}</h2>
        //                 <p class="users-messages-contents">Message: ${msg.msg}</p>
        //             </div>
        //         </div>
        //     `
        //     return htmlContent
        // }

        function listenToNewMessages() {
            // child_added will be evoked for every child that was added
            // on the first entry, it will bring all the childs

        }
        function deleteAll(refs, fun) {
            refs.once("value", snapshot => {
                snapshot.forEach(element => {
                    refs.child(element.key).remove();
                });
                fun();
            })
        }

        function listenToRemove() {
            ref.on("child_removed", snapshot => {
                msgArr = msgArr.filter(m => m.content != snapshot.val().msg);
                // re-render the messages
                printMessages(msgArr);
            })
        }
        function deleteMsgsBySubString() {
            let subString = document.getElementById("delTB").value;
            if (subString == "") {
                alert("substing can not be empty");
                return;
            }
            ref.once("value", snapshot => {
                snapshot.forEach(element => {
                    // check if contains the substring
                    if (element.val().msg.indexOf(subString) > -1) {
                        ref.child(element.key).remove();
                    }
                });
            })
        }
        // img url // name // text // imgURL
        function printMessage(msg) {
            let str = renderMessage(msg);
            ph2.innerHTML += str;
        }

        function printMessages(msgArr) {
            var str = "";
            for (let index = 0; index < msgArr.length; index++) {
                const msg = msgArr[index];
                str += renderMessage(msg);
            }
            ph2.innerHTML = str;
        }

        function AddMSG() {
            let msg = document.getElementById("msgTB").value;
            let name = document.getElementById("nameTB").value;
            if (name == "") {
                alert("must enter a name");
                return;
            }
            otherUserId = "2"
            ref_user = firebase.database().ref(`messages/${user.Id}`);
            ref_user.push().set({
                "msg": msg,
                "name": name,
                "imgURL": user.imgUrl,
                "userForm": user.Id,
                "UserTo": otherUserId
            });
        }

    </script>



    <style>
        .users-images {
            border-radius: 50%;
            object-fit: contain;
            height: 50px;
            width: 50px;
            background-color: pink;
        }

        .message-row {
            display: flex;
            flex-direction: row;

        }

        .message-contatiner {
            background-color: lightblue;
            border-radius: 15px;
            padding: 10px;
            margin: 10px;
        }

        .message-contatiner p {
            margin: 0;
        }

        .revers-flex .message-contatiner {
            background-color: lightgreen;

        }

        .revers-flex {
            flex-direction: row-reverse;
        }
    </style>

</head>

<body onload="init()">
    <div class="message-area">
        <div class="message-row revers-flex">
            <div>
                <img class="users-images" src="https://picsum.photos/id/237/200/300" alt="">
            </div>
            <div class="message-contatiner">
                <p class="users-names">Name</p>
                <p class="users-messages-contents">Lorem ipsum dolor sit amet consectetur adipisicing elit. Pariatur
                    iure
                    nostrum explicabo autem blanditiis
                    a qui harum eos? Ipsum unde explicabo nobis porro natus, nam labore reprehenderit ea voluptatum
                    provident.</p>
            </div>
        </div>
        <div class="message-row ">
            <div>
                <img class="users-images" src="https://picsum.photos/id/237/200/300" alt="">
            </div>
            <div class="message-contatiner">
                <h2 class="users-names">Name</h2>
                <p class="users-messages-contents">Lorem ipsum dolor sit amet consectetur adipisicing elit. Pariatur
                    iure
                    nostrum explicabo autem blanditiis
                    a qui harum eos? Ipsum unde explicabo nobis porro natus, nam labore reprehenderit ea voluptatum
                    provident.</p>
            </div>
        </div>
    </div>

    <input type="text" id="nameTB" placeholder="Enter your name" />
    <input type="text" id="nameTB" placeholder="Enter your id" />
    <!--<button onclick="AddName()">Add Name</button>-->
    <br />
    <br />

    <input type="text" id="msgTB" />
    <button onclick="AddMSG()">Add Message</button>

    <br />
    <br />

    <input type="text" id="delTB" placeholder="enter substring to delete" />
    <button onclick="deleteMsgsBySubString()">Delete Message</button>


    <div id="ph"></div>
    <div id="ph2"></div>

</body>

</html>